<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b00000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="模型合集">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>模型合集</title>

  <style>
    :root{
      --bg:#0b0b0f; --card:#11111a; --line:rgba(255,255,255,.10);
      --text:#f5f5f7; --muted:rgba(255,255,255,.65);
      --red:#ff2d2d; --red2:#b00000;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(800px 400px at 50% 20%, rgba(255,45,45,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(176,0,0,.22), transparent 60%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      padding:18px;
    }
    .app{width:min(640px,100%);}
    .title{
      font-size:22px;font-weight:900;letter-spacing:.5px;margin:0 0 12px;
      display:flex;align-items:center;gap:10px;
    }
    .title::before{
      content:"";width:10px;height:10px;border-radius:50%;
      background:var(--red);box-shadow:0 0 18px rgba(255,45,45,.8);
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,45,45,.08), transparent 50%), var(--card);
      border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    input{
      width:100%;padding:14px 14px;font-size:20px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);outline:none;
    }
    input:focus{border-color:rgba(255,45,45,.6);box-shadow:0 0 0 3px rgba(255,45,45,.15);}
    button{
      width:100%;margin-top:10px;padding:12px 14px;font-size:16px;font-weight:900;
      border-radius:14px;border:1px solid rgba(255,45,45,.55);
      background:linear-gradient(180deg, rgba(255,45,45,.95), rgba(176,0,0,.95));
      color:#fff;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px;}
    .seatWrap{
      margin-top:12px;padding:14px;border-radius:16px;
      border:1px dashed rgba(255,45,45,.35);background:rgba(255,45,45,.06);
      display:none;
    }
    .seatRow{display:flex; align-items:flex-end; gap:12px; justify-content:space-between; flex-wrap:wrap;}
    .seat{font-size:54px;font-weight:1000;letter-spacing:1px;color:var(--red);text-shadow:0 0 18px rgba(255,45,45,.35);}
    .sub{margin-top:6px;font-size:13px;color:var(--muted);white-space:pre-line;}
    .tiny{margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .history{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .historyHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .historyTitle{font-weight:900;}
    .ghostBtn{
      padding:8px 10px; font-size:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      width:auto;
      margin-top:0;
    }
    .cards{display:flex; flex-direction:column; gap:10px;}
    .card{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      padding:12px;
    }
    .cardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .roomBadge{
      font-weight:1000;
      letter-spacing:.5px;
    }
    .time{
      font-size:12px; color:rgba(255,255,255,.55);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:6px 10px;
      font-size:13px;
      color:rgba(255,255,255,.78);
    }
    .name{color:rgba(255,255,255,.70)}
    .val{font-weight:900; color:var(--text)}
    .val.jump{color:rgba(255,255,255,.55); font-weight:800}
  </style>
</head>

<body>
  <div class="app">
    <div class="title">模型合集</div>

    <div class="panel">
      <input id="room" inputmode="numeric" placeholder="输入5位房号" maxlength="5" />
      <button id="go">开干</button>

      <div class="msg" id="msg"></div>

      <!-- 主显示：本次预测（八戒含偏移） -->
      <div class="seatWrap" id="seatWrap">
        <div class="seatRow">
          <div>
            <div class="seat" id="seat">—</div>
            <div class="tiny" id="hint">本次默认展示：八戒牛逼模型（含偏移）</div>
          </div>
        </div>
        <div class="sub" id="sub">—</div>
      </div>

      <div class="tiny">
        八戒（含偏移）规则：<code>A=E</code> 跳；主公式 <code>F=A+B+C+E</code>，<code>seat=(F mod 5)+2</code>；增强 <code>r=(S-X) mod 5</code>；仅 <code>r∈{0,1}</code> 才偏移，优先偏到 <code>r=4</code>；偏移失败→<b>跳</b>
      </div>

      <!-- 预测记录 -->
      <div class="history">
        <div class="historyHead">
          <div class="historyTitle">预测记录（自动保存）</div>
          <button class="ghostBtn" id="clear">清空记录</button>
        </div>
        <div class="cards" id="cards"></div>
      </div>
    </div>
  </div>

  <script>
    // 真取模：永远 0..m-1
    const mod = (n,m)=>((n % m) + m) % m;

    function digits(room5){
      const A=+room5[0], B=+room5[1], C=+room5[2], D=+room5[3], E=+room5[4];
      return {A,B,C,D,E};
    }

    // ===== 模型：蜡笔小新牛逼 =====
    function calcShin(room5){
      const {A,B,C,D,E} = digits(room5);
      const V = -4*A -3*B -2*C -3*D -E -5;
      const r = mod(V, 5);
      const seat = r + 2;
      return {
        ok:true,
        seat, seatText: `${seat}号`,
        detail: `V=${V} ｜ V mod 5=${r}`
      };
    }

    // ===== 模型：八戒牛逼（含偏移 + A=E跳 + 偏移失败=跳） =====
    function calcBajie(room5){
      const {A,B,C,D,E} = digits(room5);

      // 新增硬规则：A=E 跳
      if(A === E){
        return { ok:true, seat:null, seatText:"跳", detail:`A=E（${A}=${E}）→ 跳` };
      }

      // 主公式
      const F = A + B + C + E;
      const seat0 = mod(F,5) + 2; // 2..6

      // 增强层
      const S = A + B + C + D + E;

      const pickX = (seat)=>{
        if(seat===2) return A;
        if(seat===3) return B;
        if(seat===4) return C;
        if(seat===5) return D;
        return E; // seat===6
      };

      const rForSeat = (seat)=>{
        const X = pickX(seat);
        return mod(S - X, 5);
      };

      const r0 = rForSeat(seat0);

      // 默认不偏移
      let finalSeat = seat0;
      let movedNote = "不偏移";
      let rf = r0;

      // 只在 r=0/1 才偏移
      if(r0 === 0 || r0 === 1){
        // 候选：邻位优先，再±2（2..6）
        const cand = [];
        const pushIf = (x)=>{ if(x>=2 && x<=6 && !cand.includes(x)) cand.push(x); };
        pushIf(seat0+1);
        pushIf(seat0-1);
        pushIf(seat0+2);
        pushIf(seat0-2);

        // 先找 r=4
        let best = null;
        for(const s of cand){
          if(rForSeat(s) === 4){ best = s; break; }
        }
        // 找不到再找 r=3
        if(best === null){
          for(const s of cand){
            if(rForSeat(s) === 3){ best = s; break; }
          }
        }

        if(best !== null){
          finalSeat = best;
          rf = rForSeat(finalSeat);
          movedNote = (finalSeat === seat0) ? "不偏移" : `偏移：${seat0}→${finalSeat}`;
        }else{
          // 按你要求：偏移失败 → 直接跳
          return {
            ok:true,
            seat:null,
            seatText:"跳",
            detail:`seat0=${seat0}, r0=${r0}\n偏移失败→跳`
          };
        }
      }

      return {
        ok:true,
        seat: finalSeat,
        seatText: `${finalSeat}号`,
        detail: `seat0=${seat0}, r0=${r0}\n${movedNote} → 最终=${finalSeat}, r=${rf}`
      };
    }

    // ===== 你的“多账号/多模型”列表（以后加模型就在这里加） =====
    const MODELS = [
      { id:"bajie", name:"八戒牛逼（含偏移）", calc: calcBajie },
      { id:"shin",  name:"蜡笔小新牛逼",     calc: calcShin  },
      // 以后你还有其他账号模型，就继续往这里 append：
      // { id:"xxx", name:"某某牛逼", calc: calcXxx },
    ];

    // ===== 记录保存 =====
    const STORAGE_KEY = "model_history_v1";
    const MAX_KEEP = 30;

    function nowStr(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0, MAX_KEEP)));
    }

    function renderHistory(){
      const cardsEl = document.getElementById("cards");
      const hist = loadHistory();
      if(hist.length === 0){
        cardsEl.innerHTML = `<div class="tiny">暂无记录。输入房号后会自动保存。</div>`;
        return;
      }

      cardsEl.innerHTML = hist.map(item=>{
        const rows = item.results.map(r=>{
          const isJump = r.value === "跳";
          return `
            <div class="name">${r.name}</div>
            <div class="val ${isJump ? "jump":""}">${r.value}</div>
          `;
        }).join("");

        return `
          <div class="card">
            <div class="cardTop">
              <div class="roomBadge">房号：${item.room}</div>
              <div class="time">${item.time}</div>
            </div>
            <div class="grid">
              ${rows}
            </div>
          </div>
        `;
      }).join("");
    }

    // ===== UI & 运行 =====
    const roomEl = document.getElementById("room");
    const goEl = document.getElementById("go");
    const msgEl = document.getElementById("msg");
    const seatWrapEl = document.getElementById("seatWrap");
    const seatEl = document.getElementById("seat");
    const subEl = document.getElementById("sub");
    const clearEl = document.getElementById("clear");

    function run(){
      const s = roomEl.value.trim().replace(/\s+/g,"");
      if(!/^\d{5}$/.test(s)){
        msgEl.textContent = "请输入正确的5位数字（例如：51330）";
        seatWrapEl.style.display = "none";
        return;
      }

      // 一次性计算所有模型结果
      const results = MODELS.map(m=>{
        const out = m.calc(s);
        return { id:m.id, name:m.name, value: out.seatText };
      });

      // 主展示：默认展示八戒（含偏移）
      const main = calcBajie(s);
      msgEl.textContent = "";
      seatWrapEl.style.display = "block";
      seatEl.textContent = main.seatText;
      subEl.textContent = main.detail;

      // 记录写入历史（最新在前）
      const hist = loadHistory();
      const newItem = { room:s, time: nowStr(), results };
      const next = [newItem, ...hist].slice(0, MAX_KEEP);
      saveHistory(next);
      renderHistory();

      // 自动清空 + 继续输入
      setTimeout(()=>{ roomEl.value=""; roomEl.focus(); }, 220);
    }

    goEl.addEventListener("click", run);
    roomEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });
    clearEl.addEventListener("click", ()=>{
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      roomEl.focus();
    });

    renderHistory();
    roomEl.focus();

    // 注册离线（可选但推荐）
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js"));
    }
  </script>
</body>
</html>
