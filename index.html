<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b00000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="牛逼模型合集">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>牛逼模型合集</title>

  <style>
    :root{
      --bg:#0b0b0f; --card:#11111a; --line:rgba(255,255,255,.10);
      --text:#f5f5f7; --muted:rgba(255,255,255,.65);
      --red:#ff2d2d; --red2:#b00000; --green:#2dff7a; --amber:#ffcc33;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(800px 400px at 50% 20%, rgba(255,45,45,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(176,0,0,.22), transparent 60%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      padding:18px;
    }
    .app{width:min(860px,100%);}
    .title{
      font-size:22px;font-weight:900;letter-spacing:.5px;margin:0 0 12px;
      display:flex;align-items:center;gap:10px;
    }
    .title::before{
      content:"";width:10px;height:10px;border-radius:50%;
      background:var(--red);box-shadow:0 0 18px rgba(255,45,45,.8);
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,45,45,.08), transparent 50%), var(--card);
      border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }

    input{
      width:100%;padding:14px 14px;font-size:20px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);outline:none;
    }
    input:focus{border-color:rgba(255,45,45,.6);box-shadow:0 0 0 3px rgba(255,45,45,.15);}

    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    button{
      flex:1;
      min-width:140px;
      padding:12px 14px;font-size:15px;font-weight:900;
      border-radius:14px;border:1px solid rgba(255,45,45,.55);
      background:linear-gradient(180deg, rgba(255,45,45,.95), rgba(176,0,0,.95));
      color:#fff;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    .btnGhost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:rgba(255,255,255,.9);
    }
    .btnDanger{
      background:rgba(255,45,45,.10);
      border:1px solid rgba(255,45,45,.35);
      color:#fff;
    }
    .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px;}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:12px 12px;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .name{
      font-weight:900;letter-spacing:.3px;font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 14px rgba(255,255,255,.12);}
    .seatBig{
      font-size:30px;font-weight:1000;color:var(--red);
      text-shadow:0 0 18px rgba(255,45,45,.28);
      line-height:1.05;
      text-align:right;
      white-space:nowrap;
    }
    .meta{
      margin-top:6px;font-size:12px;color:var(--muted);
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .tag{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.75);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag.green{border-color:rgba(45,255,122,.25); color:rgba(45,255,122,.9); background:rgba(45,255,122,.06);}
    .tag.amber{border-color:rgba(255,204,51,.25); color:rgba(255,204,51,.95); background:rgba(255,204,51,.06);}
    .tag.red{border-color:rgba(255,45,45,.25); color:rgba(255,120,120,.95); background:rgba(255,45,45,.06);}

    .history{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .hTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hTitle h3{
      margin:0; font-size:14px; font-weight:900; letter-spacing:.3px; color:rgba(255,255,255,.9);
      display:flex; align-items:center; gap:8px;
    }
    .hTitle h3::before{content:""; width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,.35);}
    .hActions{display:flex; gap:10px; flex-wrap:wrap;}
    .hActions button{min-width:auto; flex:0 0 auto; padding:10px 12px; font-size:13px; border-radius:12px;}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:rgba(255,255,255,.75);
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:10px 10px;
      font-size:12px;
      color:rgba(255,255,255,.86);
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .del{
      cursor:pointer;
      color:rgba(255,45,45,.95);
      border:1px solid rgba(255,45,45,.35);
      background:rgba(255,45,45,.08);
      padding:6px 10px;
      border-radius:10px;
      font-weight:900;
      font-size:12px;
      display:inline-block;
      user-select:none;
    }
    .tiny{margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="app">
    <div class="title">牛逼模型合集（带战绩记录）</div>

    <div class="panel">
      <input id="room" inputmode="numeric" placeholder="输入5位房号（例如：51330）" maxlength="5" />
      <div class="row">
        <button id="go">开干</button>
        <button class="btnGhost" id="copyLast">复制本次结果</button>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid" id="grid" style="display:none;"></div>

      <div class="history">
        <div class="hTitle">
          <h3>战绩记录（本机保存）</h3>
          <div class="hActions">
            <button class="btnGhost" id="copyAll">复制全部</button>
            <button class="btnGhost" id="exportCsv">导出CSV</button>
            <button class="btnDanger" id="clearAll">清空</button>
          </div>
        </div>

        <div style="max-height:320px; overflow:auto; border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">时间</th>
                <th style="width:86px;">房号</th>
                <th>蜡笔小新</th>
                <th>梦见</th>
                <th>呵呵呵A</th>
                <th>呵呵呵B</th>
                <th>偏爱</th>
                <th>八戒（结构）</th>
                <th style="width:70px;">操作</th>
              </tr>
            </thead>
            <tbody id="histBody">
              <tr><td colspan="9" style="color:rgba(255,255,255,.55);">暂无记录</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="tiny">
        真取模：<code>((n%5)+5)%5</code>。当前八戒只保留：<code>结构匹配位</code> —— 若两个位子命中，输出 No1/No2（2&4同中：B=8优先4，否则优先2）。
      </div>
    </div>
  </div>

  <script>
    // ====== 基础工具 ======
    const mod = (n,m)=>((n % m) + m) % m;

    function parseABCDE(room5){
      const A=+room5[0], B=+room5[1], C=+room5[2], D=+room5[3], E=+room5[4];
      return {A,B,C,D,E};
    }

    function calcRep(room5){
      const set = new Set(room5.split(""));
      return 5 - set.size;
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const pad = (x)=>String(x).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== 各账号模型 ======

    // 蜡笔小新：V=-4A-3B-2C-3D-E-5
    function model_xj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const V = -4*A -3*B -2*C -3*D -E -5;
      const r = mod(V, 5);
      return { seat:r+2, extra:`V=${V}｜V mod 5=${r}` };
    }

    // 梦见：S=2A+C+D+E；V=B-S
    function model_mj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const S = 2*A + C + D + E;
      const V = B - S;
      const r = mod(V, 5);
      return { seat:r+2, extra:`S=${S}｜V=${V}｜V mod 5=${r}` };
    }

    // 呵呵呵A：V2=B+C+2D-2E-2
    function model_hhh_A(room5){
      const {B,C,D,E} = parseABCDE(room5);
      const V2 = B + C + 2*D - 2*E - 2;
      const r = mod(V2, 5);
      return { seat:r+2, extra:`V₂=${V2}｜V₂ mod 5=${r}` };
    }

    // 呵呵呵B：rep=5-不同数，par=1(同奇偶)否则0；S=A+B+C+D+rep+par；偶4奇5
    function model_hhh_B(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const rep = calcRep(room5);
      const par = ((D % 2) === (E % 2)) ? 1 : 0;
      const S = A + B + C + D + rep + par;
      const seat = (S % 2 === 0) ? 4 : 5;
      return { seat, extra:`rep=${rep}｜par=${par}｜S=${S}｜S%2=${S%2}` };
    }

    // ====== 偏爱（稳健口诀模型｜只替换这一段）=====
    // 口诀：
    // 先看A=7坐6；
    // 再看E∈{9,0,6,1}坐5；
    // 再看C∈{6,7}坐3；
    // 再看B=3坐2；
    // 最后D=8才考虑4；
    // 都不命中就不打。
    function model_py(room5){
      const {A,B,C,D,E} = parseABCDE(room5);

      if (A === 7) {
        return { seat: 6, action: "play", extra: `命中：A=7 → 坐6｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (new Set([9,0,6,1]).has(E)) {
        return { seat: 5, action: "play", extra: `命中：E∈{9,0,6,1} → 坐5｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (new Set([6,7]).has(C)) {
        return { seat: 3, action: "play", extra: `命中：C∈{6,7} → 坐3｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (B === 3) {
        return { seat: 2, action: "play", extra: `命中：B=3 → 坐2｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (D === 8) {
        return { seat: 4, action: "play", extra: `命中：D=8 → 坐4｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }

      return { seat: null, action: "skip", extra: `不命中 → 不打｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
    }

    // ====== 八戒·结构匹配位（最终版）=====
    // 映射：23456 -> BCDEA
    // 白名单：
    // 2(B): {2,4,8}
    // 3(C): {2,7,8}
    // 4(D): {2,4,8}
    // 5(E): {3,9}
    // 6(A): {3,5,6}
    // 分流：若 A<=E，则只允许 2号位（且仍需B白名单）；否则按命中白名单推荐
    // 排序（确保与对话一致）：若 2&4 同时命中：B=8 -> 4优先，否则 2优先；其余顺序：4,2,5,3,6
    function model_bj_struct(room5){
      const {A,B,C,D,E} = parseABCDE(room5);

      const WL = {
        2: new Set([2,4,8]),    // B
        3: new Set([2,7,8]),    // C
        4: new Set([2,4,8]),    // D
        5: new Set([3,9]),      // E
        6: new Set([3,5,6])     // A
      };

      const hits = [];
      const aLeE = (A <= E);

      if(aLeE){
        if(WL[2].has(B)){
          hits.push(2);
        }else{
          return {
            action: "skip",
            recs: [],
            no1: null,
            no2: null,
            seatBig: "跳",
            extra: `A=${A} B=${B} C=${C} D=${D} E=${E}｜分流(A≤E)只允许2号，但B=${B}不在{2,4,8}`,
            tags: [{t:"跳（分流不满足）", cls:"red"}]
          };
        }
      }else{
        if(WL[2].has(B)) { hits.push(2); }
        if(WL[3].has(C)) { hits.push(3); }
        if(WL[4].has(D)) { hits.push(4); }
        if(WL[5].has(E)) { hits.push(5); }
        if(WL[6].has(A)) { hits.push(6); }

        if(hits.length === 0){
          return {
            action: "skip",
            recs: [],
            no1: null,
            no2: null,
            seatBig: "跳",
            extra: `A=${A} B=${B} C=${C} D=${D} E=${E}｜无位子命中白名单`,
            tags: [{t:"跳（无命中）", cls:"red"}]
          };
        }
      }

      // 基础顺序：4,2,5,3,6
      const baseOrder = [4,2,5,3,6];
      let ordered = hits.slice().sort((x,y)=> baseOrder.indexOf(x) - baseOrder.indexOf(y));

      // 特殊：2&4同中时，B=8 -> 4优先，否则2优先
      const has2 = ordered.includes(2);
      const has4 = ordered.includes(4);
      if(has2 && has4){
        ordered = ordered.filter(x=>x!==2 && x!==4);
        if(B === 8){
          ordered.unshift(2);
          ordered.unshift(4);
        }else{
          ordered.unshift(4);
          ordered.unshift(2);
        }
      }

      const recs = ordered.slice(0,2);
      const no1 = recs[0] ?? null;
      const no2 = recs[1] ?? null;

      const seatBig =
        (no1 && no2) ? `No1 ${no1}｜No2 ${no2}` :
        (no1) ? `${no1}号` : "跳";

      const recText =
        (no1 && no2) ? `推荐No1:${no1}号｜推荐No2:${no2}号` :
        (no1) ? `推荐No1:${no1}号` : "跳";

      const flowText = aLeE ? "分流(A≤E)启用" : "常规(不分流)";
      const extra = `A=${A} B=${B} C=${C} D=${D} E=${E}｜${flowText}｜命中位=[${hits.join(",")}]｜${recText}`;

      const tags = [];
      tags.push({t: flowText, cls:"amber"});
      tags.push({t: (no1 ? "✅可打" : "❌跳"), cls: (no1 ? "green" : "red")});

      return {
        action: no1 ? "play" : "skip",
        recs, no1, no2,
        seatBig,
        extra,
        tags
      };
    }

    // ====== UI 渲染 ======
    const roomEl = document.getElementById("room");
    const goEl = document.getElementById("go");
    const copyLastEl = document.getElementById("copyLast");
    const msgEl = document.getElementById("msg");
    const gridEl = document.getElementById("grid");
    const histBodyEl = document.getElementById("histBody");

    const copyAllEl = document.getElementById("copyAll");
    const exportCsvEl = document.getElementById("exportCsv");
    const clearAllEl = document.getElementById("clearAll");

    const LS_KEY = "nb_model_history_struct_only_v1"; // 新key，避免旧记录列数不一致
    const MAX_KEEP = 200;

    let lastTextToCopy = "";

    function cardHTML({name, seatText, extra, tags=[]}){
      const tagHTML = tags.map(x => `<span class="tag ${x.cls||""}">${escapeHtml(x.t)}</span>`).join("");
      return `
        <div class="card">
          <div class="cardHead">
            <div class="name"><span class="dot"></span>${escapeHtml(name)}</div>
            <div class="seatBig">${escapeHtml(seatText)}</div>
          </div>
          <div class="meta">
            <span class="tag">${escapeHtml(extra)}</span>
            ${tagHTML}
          </div>
        </div>
      `;
    }

    function computeAll(room5){
      const xj = model_xj(room5);
      const mj = model_mj(room5);
      const hA = model_hhh_A(room5);
      const hB = model_hhh_B(room5);
      const py = model_py(room5);      // ← 偏爱已替换为口诀模型
      const bj = model_bj_struct(room5);
      return {xj, mj, hA, hB, py, bj};
    }

    function renderCards(room5, out){
      const hTagsA = [
        {t:"模型A：2/3主力参考", cls:"amber"},
        ((out.hA.seat===2||out.hA.seat===3) ? {t:"✅落在2/3", cls:"green"} : {t:"非2/3（仍输出）", cls:""} )
      ];
      const hTagsB = [{t:"模型B：只出4/5对冲", cls:"amber"}];

      gridEl.innerHTML = [
        cardHTML({name:"蜡笔小新", seatText: `${out.xj.seat}号`, extra: out.xj.extra}),
        cardHTML({name:"梦见", seatText: `${out.mj.seat}号`, extra: out.mj.extra}),
        cardHTML({name:"呵呵呵（模型A）", seatText: `${out.hA.seat}号`, extra: out.hA.extra, tags: hTagsA}),
        cardHTML({name:"呵呵呵（模型B）", seatText: `${out.hB.seat}号`, extra: out.hB.extra, tags: hTagsB}),

        // 偏爱：支持“不打”
        cardHTML({
          name:"偏爱",
          seatText: (out.py.seat ? `${out.py.seat}号` : "不打"),
          extra: out.py.extra,
          tags: out.py.seat ? [{t:"✅可打", cls:"green"}] : [{t:"❌不打", cls:"red"}]
        }),

        cardHTML({name:"八戒（结构匹配位）", seatText: out.bj.seatBig || "跳", extra: out.bj.extra, tags: out.bj.tags || []})
      ].join("");
      gridEl.style.display = "grid";
    }

    // ====== 历史记录存取 ======
    function loadHistory(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function addHistory(item){
      const arr = loadHistory();
      arr.unshift(item);
      if(arr.length > MAX_KEEP) arr.length = MAX_KEEP;
      saveHistory(arr);
      renderHistory();
    }

    function deleteHistory(id){
      const arr = loadHistory().filter(x => x.id !== id);
      saveHistory(arr);
      renderHistory();
    }

    function clearHistory(){
      saveHistory([]);
      renderHistory();
    }

    function renderHistory(){
      const arr = loadHistory();
      if(arr.length === 0){
        histBodyEl.innerHTML = `<tr><td colspan="9" style="color:rgba(255,255,255,.55);">暂无记录</td></tr>`;
        return;
      }

      histBodyEl.innerHTML = arr.map(row => `
        <tr>
          <td class="mono">${escapeHtml(fmtTime(row.ts))}</td>
          <td class="mono">${escapeHtml(row.room)}</td>
          <td class="mono">${escapeHtml(row.xj)}</td>
          <td class="mono">${escapeHtml(row.mj)}</td>
          <td class="mono">${escapeHtml(row.hA)}</td>
          <td class="mono">${escapeHtml(row.hB)}</td>
          <td class="mono">${escapeHtml(row.py)}</td>
          <td class="mono">${escapeHtml(row.bj)}</td>
          <td><span class="del" data-del="${escapeHtml(row.id)}">删</span></td>
        </tr>
      `).join("");

      histBodyEl.querySelectorAll("[data-del]").forEach(el=>{
        el.addEventListener("click", ()=>deleteHistory(el.getAttribute("data-del")));
      });
    }

    // ====== 复制/导出 ======
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        msgEl.textContent = "✅ 已复制到剪贴板";
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        msgEl.textContent = "✅ 已复制到剪贴板";
      }
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    // copyAll里会用到：取“座位前缀”
    function seatOnly(s){
      const left = String(s).split("｜")[0];
      return left;
    }

    function buildCopyLine(room5, out){
      const t = fmtTime(Date.now());
      const bjShort = (out.bj.action === "play")
        ? (out.bj.no2 ? `推荐No1:${out.bj.no1} 推荐No2:${out.bj.no2}` : `推荐No1:${out.bj.no1}`)
        : "跳";

      // 偏爱：可能“不打”
      const pySeatText = out.py.seat ? `${out.py.seat}` : "不打";

      return `${t} ${room5} ｜ 小新${out.xj.seat} 梦见${out.mj.seat} 呵A${out.hA.seat} 呵B${out.hB.seat} 偏爱${pySeatText} 八戒(${bjShort})`;
    }

    function exportCSV(){
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "暂无记录可导出";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      const header = ["time","room","xj","mj","hhhA","hhhB","pianai","bajie_struct"];
      const rows = arr.map(r => [
        new Date(r.ts).toISOString(),
        r.room, r.xj, r.mj, r.hA, r.hB, r.py, r.bj
      ]);
      const csv = [header, ...rows]
        .map(line => line.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nb_model_history.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      msgEl.textContent = "✅ CSV 已导出";
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    // ====== 主流程 ======
    function run(){
      const s = roomEl.value.trim().replace(/\s+/g,"");
      if(!/^\d{5}$/.test(s)){
        msgEl.textContent = "请输入正确的5位数字（例如：51330）";
        gridEl.style.display = "none";
        gridEl.innerHTML = "";
        return;
      }

      const out = computeAll(s);
      renderCards(s, out);

      lastTextToCopy = buildCopyLine(s, out);

      const bjShort = (out.bj.action === "play")
        ? (out.bj.no2 ? `推荐No1:${out.bj.no1}号｜推荐No2:${out.bj.no2}号` : `推荐No1:${out.bj.no1}号`)
        : `跳｜${out.bj.extra}`;

      // 偏爱：seat可能是null
      const pySeatPrefix = (out.py.seat ?? "不打");

      addHistory({
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        ts: Date.now(),
        room: s,
        xj: `${out.xj.seat}｜${out.xj.extra}`,
        mj: `${out.mj.seat}｜${out.mj.extra}`,
        hA: `${out.hA.seat}｜${out.hA.extra}`,
        hB: `${out.hB.seat}｜${out.hB.extra}`,
        py: `${pySeatPrefix}｜${out.py.extra}`,
        bj: bjShort
      });

      msgEl.textContent = "";
      setTimeout(()=>{ roomEl.value=""; roomEl.focus(); }, 250);
    }

    goEl.addEventListener("click", run);
    roomEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });

    copyLastEl.addEventListener("click", ()=>{
      if(!lastTextToCopy){
        msgEl.textContent = "还没有本次结果可复制";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      copyText(lastTextToCopy);
    });

    copyAllEl.addEventListener("click", ()=>{
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "暂无记录可复制";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }

      const lines = arr
        .slice()
        .reverse()
        .map(r => {
          const t = fmtTime(r.ts);

          // 偏爱：可能“不打”
          const pySeat = seatOnly(r.py);

          return `${t} ${r.room} ｜ 小新${seatOnly(r.xj)} 梦见${seatOnly(r.mj)} 呵A${seatOnly(r.hA)} 呵B${seatOnly(r.hB)} 偏爱${pySeat} 八戒(${r.bj.split("｜")[0]})`;
        });
      copyText(lines.join("\n"));
    });

    exportCsvEl.addEventListener("click", exportCSV);

    clearAllEl.addEventListener("click", ()=>{
      if(confirm("确认清空所有战绩记录？（本机保存会被删除）")){
        clearHistory();
        msgEl.textContent = "✅ 已清空";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
      }
    });

    // 初始化
    renderHistory();
    roomEl.focus();

    // 注册离线
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js"));
    }
  </script>
</body>
</html>
