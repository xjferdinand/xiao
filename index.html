<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b00000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="八戒牛逼">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>八戒牛逼模型</title>

  <style>
    :root{
      --bg:#0b0b0f; --card:#11111a; --line:rgba(255,255,255,.10);
      --text:#f5f5f7; --muted:rgba(255,255,255,.65);
      --red:#ff2d2d; --red2:#b00000;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(800px 400px at 50% 20%, rgba(255,45,45,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(176,0,0,.22), transparent 60%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      padding:18px;
    }
    .app{width:min(680px,100%);}
    .title{
      font-size:22px;font-weight:900;letter-spacing:.5px;margin:0 0 12px;
      display:flex;align-items:center;gap:10px;
    }
    .title::before{
      content:"";width:10px;height:10px;border-radius:50%;
      background:var(--red);box-shadow:0 0 18px rgba(255,45,45,.8);
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,45,45,.08), transparent 50%), var(--card);
      border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    input{
      width:100%;padding:14px 14px;font-size:20px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);outline:none;
    }
    input:focus{border-color:rgba(255,45,45,.6);box-shadow:0 0 0 3px rgba(255,45,45,.15);}
    button{
      width:100%;margin-top:10px;padding:12px 14px;font-size:16px;font-weight:900;
      border-radius:14px;border:1px solid rgba(255,45,45,.55);
      background:linear-gradient(180deg, rgba(255,45,45,.95), rgba(176,0,0,.95));
      color:#fff;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px;}
    .seatWrap{
      margin-top:12px;padding:14px;border-radius:16px;
      border:1px dashed rgba(255,45,45,.35);background:rgba(255,45,45,.06);text-align:center;
      display:none;
    }
    .seat{font-size:56px;font-weight:1000;letter-spacing:1px;color:var(--red);text-shadow:0 0 18px rgba(255,45,45,.35);}
    .sub{margin-top:6px;font-size:13px;color:var(--muted);white-space:pre-line;}
    .tiny{margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* 记录表 */
    .history{
      margin-top:14px;border-top:1px solid var(--line);padding-top:14px;
    }
    .historyHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;
    }
    .historyTitle{font-size:14px;font-weight:900;color:rgba(255,255,255,.85);}
    .ghostBtn{
      padding:8px 10px;font-size:12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:#fff;cursor:pointer;
    }
    .ghostBtn:active{transform:translateY(1px);}
    .tableWrap{
      overflow:auto;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);
    }
    table{width:100%;border-collapse:collapse;min-width:520px;}
    th, td{
      padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px;text-align:left;white-space:nowrap;
    }
    th{color:rgba(255,255,255,.75);font-weight:900;background:rgba(255,255,255,.03);}
    tr:last-child td{border-bottom:none;}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;
      border:1px solid rgba(255,45,45,.35);background:rgba(255,45,45,.10);
      color:rgba(255,255,255,.9);font-weight:900;
    }
    .pillSkip{
      border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="title">八戒牛逼模型（含偏移）</div>

    <div class="panel">
      <input id="room" inputmode="numeric" placeholder="输入5位房号" maxlength="5" />
      <button id="go">开干</button>

      <div class="msg" id="msg"></div>

      <div class="seatWrap" id="seatWrap">
        <div class="seat" id="seat">—</div>
        <div class="sub" id="sub">—</div>
      </div>

      <div class="tiny">
        规则摘要：
        <code>A=E</code> 跳；
        主公式 <code>F=A+B+C+E</code>，<code>seat0=(F mod 5)+2</code>；
        <code>r=(S-X) mod 5</code>，仅 <code>r∈{0,1}</code> 偏移（优先 r=4，其次 r=3，失败=跳）；
        毒点触发二次偏移（2看B=8、3看C=6、4看D=3、5看E=8/0；避不开=跳）。
      </div>

      <div class="history">
        <div class="historyHead">
          <div class="historyTitle">最近预测记录（自动保存）</div>
          <button class="ghostBtn" id="clearHistory">清空记录</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>房号</th>
                <th>预测</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // 真取模：永远 0..m-1
    const mod = (n,m)=>((n % m) + m) % m;

    // ===== 八戒牛逼模型（含偏移 + A=E跳 + 偏移失败=跳 + 毒点二次偏移） =====
    function calcBajie(room5){
      const A=+room5[0], B=+room5[1], C=+room5[2], D=+room5[3], E=+room5[4];

      // 规则0：A=E 跳
      if(A === E){
        return { seatText:"跳", detail:`A=E（${A}=${E}）→ 默认跳过` };
      }

      // 主公式
      const F = A + B + C + E;
      const seat0 = mod(F,5) + 2; // 2..6

      // 增强层
      const S = A + B + C + D + E;

      // X按座位取：2->A,3->B,4->C,5->D,6->E
      const pickX = (seat)=>{
        if(seat===2) return A;
        if(seat===3) return B;
        if(seat===4) return C;
        if(seat===5) return D;
        return E; // 6
      };
      const rForSeat = (seat)=>mod(S - pickX(seat), 5);

      // 毒点（BCDE→2345 口径）
      const isToxic = (seat)=>{
        if(seat===2) return (B===8);            // 2号看B
        if(seat===3) return (C===6);            // 3号看C
        if(seat===4) return (D===3);            // 4号看D
        if(seat===5) return (E===8 || E===0);   // 5号看E
        return false; // 6号暂不设
      };

      const candidatesNear = (baseSeat)=>{
        const cand=[];
        const pushIf=(x)=>{ if(x>=2 && x<=6 && !cand.includes(x)) cand.push(x); };
        pushIf(baseSeat+1); pushIf(baseSeat-1);
        pushIf(baseSeat+2); pushIf(baseSeat-2);
        return cand;
      };

      // Step 1：r偏移（仅 r=0/1 才偏移；失败=跳）
      const r0 = rForSeat(seat0);
      let seat1 = seat0;
      let moved1 = false;

      if(r0===0 || r0===1){
        const cand = candidatesNear(seat0);

        let best = null;
        for(const s of cand){ if(rForSeat(s)===4){ best=s; break; } }
        if(best===null){
          for(const s of cand){ if(rForSeat(s)===3){ best=s; break; } }
        }
        if(best===null){
          return { seatText:"跳", detail:`seat0=${seat0} r0=${r0} → 偏移失败（无 r=4/3）` };
        }
        seat1 = best;
        moved1 = (seat1 !== seat0);
      }

      // Step 2：毒点二次偏移（踩毒就偏；避不开=跳）
      let seatF = seat1;
      let moved2 = false;

      if(isToxic(seatF)){
        const cand2 = candidatesNear(seatF);

        const pickBestNoToxic = (targetR)=>{
          for(const s of cand2){
            if(!isToxic(s) && rForSeat(s)===targetR) return s;
          }
          return null;
        };

        let best2 = pickBestNoToxic(4);
        if(best2===null) best2 = pickBestNoToxic(3);
        if(best2===null) best2 = pickBestNoToxic(2);

        if(best2===null){
          return { seatText:"跳", detail:`命中毒点（seat=${seatF}）→ 二次偏移失败 → 跳` };
        }
        seatF = best2;
        moved2 = (seatF !== seat1);
      }

      const rf = rForSeat(seatF);

      // 输出详情（多行，方便你核对）
      const notes = [];
      notes.push(`seat0=${seat0} r0=${r0}`);
      if(moved1) notes.push(`r偏移：${seat0}→${seat1}（r=${rForSeat(seat1)}）`);
      if(isToxic(seat1)) notes.push(`毒点触发：seat=${seat1}`);
      if(moved2) notes.push(`毒偏移：${seat1}→${seatF}（r=${rf}）`);
      if(!moved1 && !moved2) notes.push(`不偏移 → r=${rf}`);

      return { seatText: `${seatF}号`, detail: notes.join("\n") };
    }

    // ===== 记录（自动保存） =====
    const HISTORY_KEY = "bajie_history_v1";
    const HISTORY_MAX = 60;

    const roomEl = document.getElementById("room");
    const goEl = document.getElementById("go");
    const msgEl = document.getElementById("msg");
    const seatWrapEl = document.getElementById("seatWrap");
    const seatEl = document.getElementById("seat");
    const subEl = document.getElementById("sub");
    const historyBody = document.getElementById("historyBody");
    const clearBtn = document.getElementById("clearHistory");

    function fmtTime(d){
      const pad=(x)=>String(x).padStart(2,"0");
      return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function loadHistory(){
      try{
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveHistory(arr){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0, HISTORY_MAX)));
    }
    function renderHistory(){
      const hist = loadHistory();
      historyBody.innerHTML = "";
      hist.forEach(row=>{
        const tr = document.createElement("tr");
        const td = (html)=>{ const el=document.createElement("td"); el.innerHTML=html; return el; };
        tr.appendChild(td(row.time));
        tr.appendChild(td(`<span class="pill">${row.room}</span>`));
        const isSkip = (row.result === "跳");
        tr.appendChild(td(`<span class="pill ${isSkip ? "pillSkip":""}">${row.result}</span>`));
        historyBody.appendChild(tr);
      });
    }
    function appendHistory(room5, result){
      const hist = loadHistory();
      hist.unshift({ time: fmtTime(new Date()), room: room5, result });
      saveHistory(hist);
      renderHistory();
    }

    function run(){
      const s = roomEl.value.trim().replace(/\s+/g,"");
      if(!/^\d{5}$/.test(s)){
        msgEl.textContent = "请输入正确的5位数字（例如：51330）";
        seatWrapEl.style.display = "none";
        return;
      }

      const out = calcBajie(s);

      msgEl.textContent = "";
      seatWrapEl.style.display = "block";
      seatEl.textContent = out.seatText;
      subEl.textContent = out.detail;

      appendHistory(s, out.seatText);

      setTimeout(()=>{ roomEl.value=""; roomEl.focus(); }, 250);
    }

    goEl.addEventListener("click", run);
    roomEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });
    clearBtn.addEventListener("click", ()=>{
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    });

    renderHistory();
    roomEl.focus();

    // 离线（可选）
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js"));
    }
  </script>
</body>
</html>
