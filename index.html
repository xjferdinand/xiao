<!-- index.html（完整版：已加入「雅静T值终极模型 v2」；其它模型保持不变） -->
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b00000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="牛逼模型合集">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>牛逼模型合集</title>

  <style>
    :root{
      --bg:#0b0b0f; --card:#11111a; --line:rgba(255,255,255,.10);
      --text:#f5f5f7; --muted:rgba(255,255,255,.65);
      --red:#ff2d2d; --red2:#b00000; --green:#2dff7a; --amber:#ffcc33;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(800px 400px at 50% 20%, rgba(255,45,45,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(176,0,0,.22), transparent 60%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      padding:18px;
    }
    .app{width:min(860px,100%);}
    .title{
      font-size:22px;font-weight:900;letter-spacing:.5px;margin:0 0 12px;
      display:flex;align-items:center;gap:10px;
    }
    .title::before{
      content:"";width:10px;height:10px;border-radius:50%;
      background:var(--red);box-shadow:0 0 18px rgba(255,45,45,.8);
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,45,45,.08), transparent 50%), var(--card);
      border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }

    input{
      width:100%;padding:14px 14px;font-size:20px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);outline:none;
    }
    input:focus{border-color:rgba(255,45,45,.6);box-shadow:0 0 0 3px rgba(255,45,45,.15);}

    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    button{
      flex:1;
      min-width:140px;
      padding:12px 14px;font-size:15px;font-weight:900;
      border-radius:14px;border:1px solid rgba(255,45,45,.55);
      background:linear-gradient(180deg, rgba(255,45,45,.95), rgba(176,0,0,.95));
      color:#fff;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    .btnGhost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:rgba(255,255,255,.9);
    }
    .btnDanger{
      background:rgba(255,45,45,.10);
      border:1px solid rgba(255,45,45,.35);
      color:#fff;
    }
    .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px;}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:12px 12px;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .name{
      font-weight:900;letter-spacing:.3px;font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 14px rgba(255,255,255,.12);}
    .seatBig{
      font-size:30px;font-weight:1000;color:var(--red);
      text-shadow:0 0 18px rgba(255,45,45,.28);
      line-height:1.05;
      text-align:right;
      white-space:nowrap;
    }
    .meta{
      margin-top:6px;font-size:12px;color:var(--muted);
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .tag{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.75);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag.green{border-color:rgba(45,255,122,.25); color:rgba(45,255,122,.9); background:rgba(45,255,122,.06);}
    .tag.amber{border-color:rgba(255,204,51,.25); color:rgba(255,204,51,.95); background:rgba(255,204,51,.06);}
    .tag.red{border-color:rgba(255,45,45,.25); color:rgba(255,120,120,.95); background:rgba(255,45,45,.06);}

    .history{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .hTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hTitle h3{
      margin:0; font-size:14px; font-weight:900; letter-spacing:.3px; color:rgba(255,255,255,.9);
      display:flex; align-items:center; gap:8px;
    }
    .hTitle h3::before{content:""; width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,.35);}
    .hActions{display:flex; gap:10px; flex-wrap:wrap;}
    .hActions button{min-width:auto; flex:0 0 auto; padding:10px 12px; font-size:13px; border-radius:12px;}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:rgba(255,255,255,.75);
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:10px 10px;
      font-size:12px;
      color:rgba(255,255,255,.86);
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .del{
      cursor:pointer;
      color:rgba(255,45,45,.95);
      border:1px solid rgba(255,45,45,.35);
      background:rgba(255,45,45,.08);
      padding:6px 10px;
      border-radius:10px;
      font-weight:900;
      font-size:12px;
      display:inline-block;
      user-select:none;
    }
    .tiny{margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="app">
    <div class="title">牛逼模型合集（带战绩记录）</div>

    <div class="panel">
      <input id="room" inputmode="numeric" placeholder="输入5位房号（例如：51330）" maxlength="5" />
      <div class="row">
        <button id="go">开干</button>
        <button class="btnGhost" id="copyLast">复制本次结果</button>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid" id="grid" style="display:none;"></div>

      <div class="history">
        <div class="hTitle">
          <h3>战绩记录（本机保存）</h3>
          <div class="hActions">
            <button class="btnGhost" id="copyAll">复制全部</button>
            <button class="btnGhost" id="exportCsv">导出CSV</button>
            <button class="btnDanger" id="clearAll">清空</button>
          </div>
        </div>

        <div style="max-height:320px; overflow:auto; border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">时间</th>
                <th style="width:86px;">房号</th>

                <!-- 八戒三列（最终置顶）：最终 / 1T / 2~6 -->
                <th>八戒最终</th>
                <th>八戒1号T</th>
                <th>八戒T双甜点(2~6)</th>

                <!-- ✅ 新增：雅静T值终极模型 v2 -->
                <th>雅静T值v2</th>

                <th>蜡笔小新</th>
                <th>梦见</th>
                <th>呵呵呵A</th>
                <th>呵呵呵B</th>
                <th>偏爱</th>

                <th style="width:70px;">操作</th>
              </tr>
            </thead>
            <tbody id="histBody">
              <tr><td colspan="13" style="color:rgba(255,255,255,.55);">暂无记录</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="tiny">
        ✅ 八戒口径统一：页面与我对话都以 <code>八戒最终推荐（只输出一个）</code> 为准。规则：<code>2~6双甜点优先</code> → <code>1T兜底</code> → 否则跳。
      </div>
    </div>
  </div>

  <script>
    // ====== 基础工具 ======
    const mod = (n,m)=>((n % m) + m) % m;

    function parseABCDE(room5){
      const A=+room5[0], B=+room5[1], C=+room5[2], D=+room5[3], E=+room5[4];
      return {A,B,C,D,E};
    }

    function calcRep(room5){
      const set = new Set(room5.split(""));
      return 5 - set.size;
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const pad = (x)=>String(x).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== 各账号模型 ======

    // 蜡笔小新：V=-4A-3B-2C-3D-E-5
    function model_xj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const V = -4*A -3*B -2*C -3*D -E -5;
      const r = mod(V, 5);
      return { seat:r+2, extra:`V=${V}｜V mod 5=${r}` };
    }

    // 梦见：S=2A+C+D+E；V=B-S
    function model_mj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const S = 2*A + C + D + E;
      const V = B - S;
      const r = mod(V, 5);
      return { seat:r+2, extra:`S=${S}｜V=${V}｜V mod 5=${r}` };
    }

    // 呵呵呵A：V2=B+C+2D-2E-2
    function model_hhh_A(room5){
      const {B,C,D,E} = parseABCDE(room5);
      const V2 = B + C + 2*D - 2*E - 2;
      const r = mod(V2, 5);
      return { seat:r+2, extra:`V₂=${V2}｜V₂ mod 5=${r}` };
    }

    // 呵呵呵B：rep=5-不同数，par=1(同奇偶)否则0；S=A+B+C+D+rep+par；偶4奇5
    function model_hhh_B(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const rep = calcRep(room5);
      const par = ((D % 2) === (E % 2)) ? 1 : 0;
      const S = A + B + C + D + rep + par;
      const seat = (S % 2 === 0) ? 4 : 5;
      return { seat, extra:`rep=${rep}｜par=${par}｜S=${S}｜S%2=${S%2}` };
    }

    // ====== 偏爱（稳健口诀模型｜保持不变）=====
    function model_py(room5){
      const {A,B,C,D,E} = parseABCDE(room5);

      if (A === 7) {
        return { seat: 6, action: "play", extra: `命中：A=7 → 坐6｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (new Set([9,0,6,1]).has(E)) {
        return { seat: 5, action: "play", extra: `命中：E∈{9,0,6,1} → 坐5｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (new Set([6,7]).has(C)) {
        return { seat: 3, action: "play", extra: `命中：C∈{6,7} → 坐3｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (B === 3) {
        return { seat: 2, action: "play", extra: `命中：B=3 → 坐2｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }
      if (D === 8) {
        return { seat: 4, action: "play", extra: `命中：D=8 → 坐4｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
      }

      return { seat: null, action: "skip", extra: `不命中 → 不打｜A=${A} B=${B} C=${C} D=${D} E=${E}` };
    }

    // ============================================================
    // ✅ 雅静T值终极模型 v2（新增）
    // 定义：
    //   S = A+B+C+D+E
    //   T2=S-B, T3=S-C, T5=S-E, T6=S-A
    // 甜点（黄金T值）：
    //   sweet[2] = {11,16,18,25}
    //   sweet[3] = {16,19,21,23,24}
    //   sweet[5] = {13,19,20,25,27}
    //   sweet[6] = {11,12,16,18,19,23}
    // 多命中优先级（v2）：6 > 3 > 2 > 5
    // 输出：最多3个位子（No1 + 备选2个）；未命中则跳
    // ============================================================
    function model_yj_Tv2(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const S = A + B + C + D + E;

      const T2 = S - B;
      const T3 = S - C;
      const T5 = S - E;
      const T6 = S - A;

      const sweet = {
        2: new Set([11,16,18,25]),
        3: new Set([16,19,21,23,24]),
        5: new Set([13,19,20,25,27]),
        6: new Set([11,12,16,18,19,23])
      };

      const hits = [];
      if(sweet[2].has(T2)) hits.push(2);
      if(sweet[3].has(T3)) hits.push(3);
      if(sweet[5].has(T5)) hits.push(5);
      if(sweet[6].has(T6)) hits.push(6);

      const priority = [6,3,2,5];
      const sorted = hits.slice().sort((x,y)=>priority.indexOf(x)-priority.indexOf(y));
      const top3 = sorted.slice(0,3);

      const tMap = {2:T2,3:T3,5:T5,6:T6};
      const tStr = `S=${S}｜T2=${T2} T3=${T3} T5=${T5} T6=${T6}`;

      if(top3.length === 0){
        return {
          action:"skip",
          seat:null,
          seatBig:"跳",
          extra:`A=${A} B=${B} C=${C} D=${D} E=${E}｜${tStr}｜未命中（v2）`,
          tags:[{t:"跳（未命中）", cls:"red"}]
        };
      }

      const no1 = top3[0];
      const backups = top3.slice(1);

      const backupText = backups.length ? `｜备选=${backups.join("/")}` : "";
      const hitText = `命中=[${hits.join(",")}]｜No1=${no1}${backupText}`;

      return {
        action:"play",
        seat:no1,
        seatBig:`${no1}号`,
        extra:`A=${A} B=${B} C=${C} D=${D} E=${E}｜${tStr}｜${hitText}`,
        tags:[
          {t:"雅静T值终极v2", cls:"green"},
          {t:`最多3位：${top3.join("/")}`, cls:"amber"}
        ]
      };
    }

    // ============================================================
    // ✅ 八戒三套（最终统一口径）——保持不变
    // ============================================================

    function model_bj_1T(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const T1 = B + C + D + E;
      const ok = (T1 >= 15 && T1 <= 18);
      return {
        action: ok ? "play" : "skip",
        seat: ok ? 1 : null,
        seatBig: ok ? "1号" : "跳",
        extra: `A=${A} B=${B} C=${C} D=${D} E=${E}｜T1=BCDE=${T1}｜甜点(15~18)=${ok ? "是" : "否"}`,
        tags: ok
          ? [{t:"优质T", cls:"green"}]
          : [{t:"跳（不在甜点）", cls:"red"}]
      };
    }

    function model_bj_Tsweet_26(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const S = A + B + C + D + E;

      const T2 = S - B;
      const T3 = S - C;
      const T4 = S - D;
      const T5 = S - E;
      const T6 = S - A;

      const sweet = {
        2: new Set([14,16]),
        3: new Set([18,19]),
        4: new Set([10,11,12]),
        5: new Set([22,23]),
        6: new Set([16,17])
      };

      const hits = [];
      if(sweet[2].has(T2)) hits.push(2);
      if(sweet[3].has(T3)) hits.push(3);
      if(sweet[4].has(T4)) hits.push(4);
      if(sweet[5].has(T5)) hits.push(5);
      if(sweet[6].has(T6)) hits.push(6);

      if(hits.length === 0){
        return {
          action:"skip",
          seat:null,
          seatBig:"跳",
          extra:`A=${A} B=${B} C=${C} D=${D} E=${E}｜S=${S}｜T2=${T2} T3=${T3} T4=${T4} T5=${T5} T6=${T6}｜未命中双甜点`,
          tags:[{t:"跳（未命中）", cls:"red"}]
        };
      }

      // 优先级：6 > 3 > 5 > 2 > 4（只输出一个位子）
      const priority = [6,3,5,2,4];
      const seat = hits.slice().sort((x,y)=>priority.indexOf(x)-priority.indexOf(y))[0];

      const tMap = {2:T2,3:T3,4:T4,5:T5,6:T6};
      const tVal = tMap[seat];

      return {
        action:"play",
        seat,
        seatBig:`${seat}号`,
        extra:`A=${A} B=${B} C=${C} D=${D} E=${E}｜S=${S}｜命中位=[${hits.join(",")}]｜No1=${seat}（T${seat}=${tVal}）`,
        tags:[{t:"优质T（双甜点）", cls:"green"}]
      };
    }

    function model_bj_final(room5){
      const bjT = model_bj_Tsweet_26(room5);
      if (bjT.action === "play") {
        return {
          action:"play",
          seat: bjT.seat,
          seatBig: `${bjT.seat}号`,
          extra: `【最终=2~6优先】${bjT.extra}`,
          tags:[{t:"最终推荐", cls:"green"}]
        };
      }

      const bj1 = model_bj_1T(room5);
      if (bj1.action === "play") {
        return {
          action:"play",
          seat: 1,
          seatBig: `1号`,
          extra: `【最终=1T兜底】${bj1.extra}`,
          tags:[{t:"最终推荐", cls:"green"}]
        };
      }

      return {
        action:"skip",
        seat:null,
        seatBig:"跳",
        extra:`【最终】2~6未中 + 1T未中 → 跳｜A=${parseABCDE(room5).A} B=${parseABCDE(room5).B} C=${parseABCDE(room5).C} D=${parseABCDE(room5).D} E=${parseABCDE(room5).E}`,
        tags:[{t:"最终推荐", cls:"red"}]
      };
    }

    // ====== UI 渲染 ======
    const roomEl = document.getElementById("room");
    const goEl = document.getElementById("go");
    const copyLastEl = document.getElementById("copyLast");
    const msgEl = document.getElementById("msg");
    const gridEl = document.getElementById("grid");
    const histBodyEl = document.getElementById("histBody");

    const copyAllEl = document.getElementById("copyAll");
    const exportCsvEl = document.getElementById("exportCsv");
    const clearAllEl = document.getElementById("clearAll");

    // ✅ 新key：表格列新增（避免旧记录结构不一致）
    const LS_KEY = "nb_model_history_with_yajingT_v2";
    const MAX_KEEP = 200;

    let lastTextToCopy = "";

    function cardHTML({name, seatText, extra, tags=[]}){
      const tagHTML = tags.map(x => `<span class="tag ${x.cls||""}">${escapeHtml(x.t)}</span>`).join("");
      return `
        <div class="card">
          <div class="cardHead">
            <div class="name"><span class="dot"></span>${escapeHtml(name)}</div>
            <div class="seatBig">${escapeHtml(seatText)}</div>
          </div>
          <div class="meta">
            <span class="tag">${escapeHtml(extra)}</span>
            ${tagHTML}
          </div>
        </div>
      `;
    }

    function computeAll(room5){
      const bjF = model_bj_final(room5);
      const bj1 = model_bj_1T(room5);
      const bjT = model_bj_Tsweet_26(room5);

      // ✅ 雅静T值终极模型 v2
      const yj = model_yj_Tv2(room5);

      const xj = model_xj(room5);
      const mj = model_mj(room5);
      const hA = model_hhh_A(room5);
      const hB = model_hhh_B(room5);
      const py = model_py(room5);

      return { bjF, bj1, bjT, yj, xj, mj, hA, hB, py };
    }

    function renderCards(room5, out){
      const hTagsA = [
        {t:"模型A：2/3主力参考", cls:"amber"},
        ((out.hA.seat===2||out.hA.seat===3) ? {t:"✅落在2/3", cls:"green"} : {t:"非2/3（仍输出）", cls:""} )
      ];
      const hTagsB = [{t:"模型B：只出4/5对冲", cls:"amber"}];

      // ✅ 八戒三张卡放最上方（最终/1T/2~6）
      // ✅ 新增：雅静T值终极模型 v2（放在八戒下面，不影响其它模型）
      gridEl.innerHTML = [
        cardHTML({name:"八戒最终推荐（只输出一个）", seatText: out.bjF.seatBig, extra: out.bjF.extra, tags: out.bjF.tags || []}),
        cardHTML({name:"八戒1号位T终极模型", seatText: out.bj1.seatBig, extra: out.bj1.extra, tags: out.bj1.tags || []}),
        cardHTML({name:"八戒T双甜点结构版（2~6）", seatText: out.bjT.seatBig, extra: out.bjT.extra, tags: out.bjT.tags || []}),

        cardHTML({name:"雅静T值终极模型 v2", seatText: out.yj.seatBig, extra: out.yj.extra, tags: out.yj.tags || []}),

        // 其它模型保持原样
        cardHTML({name:"蜡笔小新", seatText: `${out.xj.seat}号`, extra: out.xj.extra}),
        cardHTML({name:"梦见", seatText: `${out.mj.seat}号`, extra: out.mj.extra}),
        cardHTML({name:"呵呵呵（模型A）", seatText: `${out.hA.seat}号`, extra: out.hA.extra, tags: hTagsA}),
        cardHTML({name:"呵呵呵（模型B）", seatText: `${out.hB.seat}号`, extra: out.hB.extra, tags: hTagsB}),

        // 偏爱：支持“不打”
        cardHTML({
          name:"偏爱",
          seatText: (out.py.seat ? `${out.py.seat}号` : "不打"),
          extra: out.py.extra,
          tags: out.py.seat ? [{t:"✅可打", cls:"green"}] : [{t:"❌不打", cls:"red"}]
        })
      ].join("");

      gridEl.style.display = "grid";
    }

    // ====== 历史记录存取 ======
    function loadHistory(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function addHistory(item){
      const arr = loadHistory();
      arr.unshift(item);
      if(arr.length > MAX_KEEP) arr.length = MAX_KEEP;
      saveHistory(arr);
      renderHistory();
    }

    function deleteHistory(id){
      const arr = loadHistory().filter(x => x.id !== id);
      saveHistory(arr);
      renderHistory();
    }

    function clearHistory(){
      saveHistory([]);
      renderHistory();
    }

    function renderHistory(){
      const arr = loadHistory();
      if(arr.length === 0){
        histBodyEl.innerHTML = `<tr><td colspan="13" style="color:rgba(255,255,255,.55);">暂无记录</td></tr>`;
        return;
      }

      histBodyEl.innerHTML = arr.map(row => `
        <tr>
          <td class="mono">${escapeHtml(fmtTime(row.ts))}</td>
          <td class="mono">${escapeHtml(row.room)}</td>

          <td class="mono">${escapeHtml(row.bjF)}</td>
          <td class="mono">${escapeHtml(row.bj1)}</td>
          <td class="mono">${escapeHtml(row.bjT)}</td>

          <td class="mono">${escapeHtml(row.yj)}</td>

          <td class="mono">${escapeHtml(row.xj)}</td>
          <td class="mono">${escapeHtml(row.mj)}</td>
          <td class="mono">${escapeHtml(row.hA)}</td>
          <td class="mono">${escapeHtml(row.hB)}</td>
          <td class="mono">${escapeHtml(row.py)}</td>

          <td><span class="del" data-del="${escapeHtml(row.id)}">删</span></td>
        </tr>
      `).join("");

      histBodyEl.querySelectorAll("[data-del]").forEach(el=>{
        el.addEventListener("click", ()=>deleteHistory(el.getAttribute("data-del")));
      });
    }

    // ====== 复制/导出 ======
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        msgEl.textContent = "✅ 已复制到剪贴板";
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        msgEl.textContent = "✅ 已复制到剪贴板";
      }
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    function seatOnly(s){
      const left = String(s).split("｜")[0];
      return left;
    }

    function buildCopyLine(room5, out){
      const t = fmtTime(Date.now());
      const {B,C,D,E} = parseABCDE(room5);
      const T1 = B + C + D + E;

      const bjFinalShort = (out.bjF.action === "play")
        ? `${out.bjF.seat}号(最终)`
        : "跳(最终)";

      const bj1Short = (out.bj1.action === "play")
        ? `1号(优质T T1=${T1})`
        : `跳(T1=${T1})`;

      const bjTShort = (out.bjT.action === "play")
        ? `${out.bjT.seat}号(双甜点)`
        : "跳(未命中)";

      const yjShort = (out.yj.action === "play")
        ? `${out.yj.seat}号(v2)`
        : "跳(v2)";

      const pySeatText = out.py.seat ? `${out.py.seat}` : "不打";

      return `${t} ${room5} ｜ 八戒最终:${bjFinalShort} 八戒1T:${bj1Short} 八戒2~6:${bjTShort} ｜ 雅静T:${yjShort} ｜ 小新${out.xj.seat} 梦见${out.mj.seat} 呵A${out.hA.seat} 呵B${out.hB.seat} 偏爱${pySeatText}`;
    }

    function exportCSV(){
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "暂无记录可导出";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      const header = ["time","room","bajie_final","bajie_1T","bajie_T_26","yajing_Tv2","xj","mj","hhhA","hhhB","pianai"];
      const rows = arr.map(r => [
        new Date(r.ts).toISOString(),
        r.room, r.bjF, r.bj1, r.bjT, r.yj, r.xj, r.mj, r.hA, r.hB, r.py
      ]);
      const csv = [header, ...rows]
        .map(line => line.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nb_model_history.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      msgEl.textContent = "✅ CSV 已导出";
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    // ====== 主流程 ======
    function run(){
      const s = roomEl.value.trim().replace(/\s+/g,"");
      if(!/^\d{5}$/.test(s)){
        msgEl.textContent = "请输入正确的5位数字（例如：51330）";
        gridEl.style.display = "none";
        gridEl.innerHTML = "";
        return;
      }

      const out = computeAll(s);
      renderCards(s, out);

      lastTextToCopy = buildCopyLine(s, out);

      const bjFShort = (out.bjF.action === "play")
        ? `${out.bjF.seat}号｜${out.bjF.extra}`
        : `跳｜${out.bjF.extra}`;

      const bj1Short = (out.bj1.action === "play")
        ? `1号｜${out.bj1.extra}`
        : `跳｜${out.bj1.extra}`;

      const bjTShort = (out.bjT.action === "play")
        ? `${out.bjT.seat}号｜${out.bjT.extra}`
        : `跳｜${out.bjT.extra}`;

      const yjShort = (out.yj.action === "play")
        ? `${out.yj.seat}号｜${out.yj.extra}`
        : `跳｜${out.yj.extra}`;

      const pySeatPrefix = (out.py.seat ?? "不打");

      addHistory({
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        ts: Date.now(),
        room: s,

        bjF: bjFShort,
        bj1: bj1Short,
        bjT: bjTShort,

        yj: yjShort,

        xj: `${out.xj.seat}｜${out.xj.extra}`,
        mj: `${out.mj.seat}｜${out.mj.extra}`,
        hA: `${out.hA.seat}｜${out.hA.extra}`,
        hB: `${out.hB.seat}｜${out.hB.extra}`,
        py: `${pySeatPrefix}｜${out.py.extra}`
      });

      msgEl.textContent = "";
      setTimeout(()=>{ roomEl.value=""; roomEl.focus(); }, 250);
    }

    goEl.addEventListener("click", run);
    roomEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });

    copyLastEl.addEventListener("click", ()=>{
      if(!lastTextToCopy){
        msgEl.textContent = "还没有本次结果可复制";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      copyText(lastTextToCopy);
    });

    copyAllEl.addEventListener("click", ()=>{
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "暂无记录可复制";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }

      const lines = arr
        .slice()
        .reverse()
        .map(r => {
          const t = fmtTime(r.ts);
          const pySeat = seatOnly(r.py);

          return `${t} ${r.room} ｜ 八戒最终(${seatOnly(r.bjF)}) 八戒1T(${seatOnly(r.bj1)}) 八戒2~6(${seatOnly(r.bjT)}) ｜ 雅静T(${seatOnly(r.yj)}) ｜ 小新${seatOnly(r.xj)} 梦见${seatOnly(r.mj)} 呵A${seatOnly(r.hA)} 呵B${seatOnly(r.hB)} 偏爱${pySeat}`;
        });

      copyText(lines.join("\n"));
    });

    exportCsvEl.addEventListener("click", exportCSV);

    clearAllEl.addEventListener("click", ()=>{
      if(confirm("确认清空所有战绩记录？（本机保存会被删除）")){
        clearHistory();
        msgEl.textContent = "✅ 已清空";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
      }
    });

    // 初始化
    renderHistory();
    roomEl.focus();

    // 注册离线
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js"));
    }
  </script>
</body>
</html>
