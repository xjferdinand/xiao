<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b00000" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ç‰›é€¼æ¨¡å‹åˆé›†">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>ç‰›é€¼æ¨¡å‹åˆé›†</title>

  <style>
    :root{
      --bg:#0b0b0f; --card:#11111a; --line:rgba(255,255,255,.10);
      --text:#f5f5f7; --muted:rgba(255,255,255,.65);
      --red:#ff2d2d; --red2:#b00000; --green:#2dff7a; --amber:#ffcc33;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(800px 400px at 50% 20%, rgba(255,45,45,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(176,0,0,.22), transparent 60%),
        var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      padding:18px;
    }
    .app{width:min(860px,100%);}
    .title{
      font-size:22px;font-weight:900;letter-spacing:.5px;margin:0 0 12px;
      display:flex;align-items:center;gap:10px;
    }
    .title::before{
      content:"";width:10px;height:10px;border-radius:50%;
      background:var(--red);box-shadow:0 0 18px rgba(255,45,45,.8);
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,45,45,.08), transparent 50%), var(--card);
      border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }

    input{
      width:100%;padding:14px 14px;font-size:20px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--text);outline:none;
    }
    input:focus{border-color:rgba(255,45,45,.6);box-shadow:0 0 0 3px rgba(255,45,45,.15);}

    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    button{
      flex:1;
      min-width:140px;
      padding:12px 14px;font-size:15px;font-weight:900;
      border-radius:14px;border:1px solid rgba(255,45,45,.55);
      background:linear-gradient(180deg, rgba(255,45,45,.95), rgba(176,0,0,.95));
      color:#fff;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    .btnGhost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:rgba(255,255,255,.9);
    }
    .btnDanger{
      background:rgba(255,45,45,.10);
      border:1px solid rgba(255,45,45,.35);
      color:#fff;
    }
    .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px;}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:12px 12px;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .name{
      font-weight:900;letter-spacing:.3px;font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);box-shadow:0 0 14px rgba(255,255,255,.12);}
    .seatBig{
      font-size:30px;font-weight:1000;color:var(--red);
      text-shadow:0 0 18px rgba(255,45,45,.28);
      line-height:1.05;
      text-align:right;
      white-space:nowrap;
    }
    .meta{
      margin-top:6px;font-size:12px;color:var(--muted);
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .tag{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.75);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag.green{border-color:rgba(45,255,122,.25); color:rgba(45,255,122,.9); background:rgba(45,255,122,.06);}
    .tag.amber{border-color:rgba(255,204,51,.25); color:rgba(255,204,51,.95); background:rgba(255,204,51,.06);}
    .tag.red{border-color:rgba(255,45,45,.25); color:rgba(255,120,120,.95); background:rgba(255,45,45,.06);}

    .history{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .hTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hTitle h3{
      margin:0; font-size:14px; font-weight:900; letter-spacing:.3px; color:rgba(255,255,255,.9);
      display:flex; align-items:center; gap:8px;
    }
    .hTitle h3::before{content:""; width:8px;height:8px;border-radius:50%; background:rgba(255,255,255,.35);}
    .hActions{display:flex; gap:10px; flex-wrap:wrap;}
    .hActions button{min-width:auto; flex:0 0 auto; padding:10px 12px; font-size:13px; border-radius:12px;}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:rgba(255,255,255,.75);
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:10px 10px;
      font-size:12px;
      color:rgba(255,255,255,.86);
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .del{
      cursor:pointer;
      color:rgba(255,45,45,.95);
      border:1px solid rgba(255,45,45,.35);
      background:rgba(255,45,45,.08);
      padding:6px 10px;
      border-radius:10px;
      font-weight:900;
      font-size:12px;
      display:inline-block;
      user-select:none;
    }
    .tiny{margin-top:12px;font-size:12px;color:rgba(255,255,255,.5)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="app">
    <div class="title">ç‰›é€¼æ¨¡å‹åˆé›†ï¼ˆå¸¦æˆ˜ç»©è®°å½•ï¼‰</div>

    <div class="panel">
      <input id="room" inputmode="numeric" placeholder="è¾“å…¥5ä½æˆ¿å·ï¼ˆä¾‹å¦‚ï¼š51330ï¼‰" maxlength="5" />
      <div class="row">
        <button id="go">å¼€å¹²</button>
        <button class="btnGhost" id="copyLast">å¤åˆ¶æœ¬æ¬¡ç»“æœ</button>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid" id="grid" style="display:none;"></div>

      <div class="history">
        <div class="hTitle">
          <h3>æˆ˜ç»©è®°å½•ï¼ˆæœ¬æœºä¿å­˜ï¼‰</h3>
          <div class="hActions">
            <button class="btnGhost" id="copyAll">å¤åˆ¶å…¨éƒ¨</button>
            <button class="btnGhost" id="exportCsv">å¯¼å‡ºCSV</button>
            <button class="btnDanger" id="clearAll">æ¸…ç©º</button>
          </div>
        </div>

        <div style="max-height:320px; overflow:auto; border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">æ—¶é—´</th>
                <th style="width:86px;">æˆ¿å·</th>
                <th>èœ¡ç¬”å°æ–°</th>
                <th>æ¢¦è§</th>
                <th>å‘µå‘µå‘µA</th>
                <th>å‘µå‘µå‘µB</th>
                <th>å…«æˆ’ï¼ˆFï¼‰</th>
                <th>åçˆ±</th>
                <th>å…«æˆ’åˆ«è·‘Â·ç»“æ„</th>
                <th style="width:70px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="histBody">
              <tr><td colspan="10" style="color:rgba(255,255,255,.55);">æš‚æ— è®°å½•</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="tiny">
        çœŸå–æ¨¡ï¼š<code>((n%5)+5)%5</code>ã€‚æ–°å¢ï¼š<code>å…«æˆ’åˆ«è·‘Â·ç»“æ„åŒ¹é…ä½</code> â€”â€” è‹¥ä¸¤ä¸ªä½å­åŒæ—¶å‘½ä¸­ï¼Œè¾“å‡º No1/No2ï¼Œä¸”ä¸å¯¹è¯ä¸€è‡´ï¼ˆ2&4åŒä¸­ï¼šB=8ä¼˜å…ˆ4ï¼Œå¦åˆ™ä¼˜å…ˆ2ï¼‰ã€‚
      </div>
    </div>
  </div>

  <script>
    // ====== åŸºç¡€å·¥å…· ======
    const mod = (n,m)=>((n % m) + m) % m;

    function parseABCDE(room5){
      const A=+room5[0], B=+room5[1], C=+room5[2], D=+room5[3], E=+room5[4];
      return {A,B,C,D,E};
    }

    function calcRep(room5){
      const set = new Set(room5.split(""));
      return 5 - set.size;
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const pad = (x)=>String(x).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== å„è´¦å·æ¨¡å‹ ======

    // èœ¡ç¬”å°æ–°ï¼šV=-4A-3B-2C-3D-E-5
    function model_xj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const V = -4*A -3*B -2*C -3*D -E -5;
      const r = mod(V, 5);
      return { seat:r+2, extra:`V=${V}ï½œV mod 5=${r}` };
    }

    // æ¢¦è§ï¼šS=2A+C+D+Eï¼›V=B-S
    function model_mj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const S = 2*A + C + D + E;
      const V = B - S;
      const r = mod(V, 5);
      return { seat:r+2, extra:`S=${S}ï½œV=${V}ï½œV mod 5=${r}` };
    }

    // å‘µå‘µå‘µAï¼šV2=B+C+2D-2E-2
    function model_hhh_A(room5){
      const {B,C,D,E} = parseABCDE(room5);
      const V2 = B + C + 2*D - 2*E - 2;
      const r = mod(V2, 5);
      return { seat:r+2, extra:`Vâ‚‚=${V2}ï½œVâ‚‚ mod 5=${r}` };
    }

    // å‘µå‘µå‘µBï¼šrep=5-ä¸åŒæ•°ï¼Œpar=1(åŒå¥‡å¶)å¦åˆ™0ï¼›S=A+B+C+D+rep+parï¼›å¶4å¥‡5
    function model_hhh_B(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const rep = calcRep(room5);
      const par = ((D % 2) === (E % 2)) ? 1 : 0;
      const S = A + B + C + D + rep + par;
      const seat = (S % 2 === 0) ? 4 : 5;
      return { seat, extra:`rep=${rep}ï½œpar=${par}ï½œS=${S}ï½œS%2=${S%2}` };
    }

    // å…«æˆ’ï¼ˆFæ¨¡å‹ï¼‰ï¼šF=A+B+C+Eï¼›seat=(F mod5)+2ï¼›å¼ºä¿¡å· max(BCDE)>=8
    function model_bj(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const F = A + B + C + E;
      const r = mod(F, 5);
      const seat = r + 2;
      const mx = Math.max(B,C,D,E);
      const strong = mx >= 8;
      return {
        seat,
        extra:`F=${F}ï½œF mod 5=${r}ï½œmax(BCDE)=${mx}`,
        strong
      };
    }

    // åçˆ±ï¼šV=-2A-B+2C-D+2E-2
    function model_py(room5){
      const {A,B,C,D,E} = parseABCDE(room5);
      const V = -2*A - B + 2*C - D + 2*E - 2;
      const r = mod(V, 5);
      return { seat:r+2, extra:`V=${V}ï½œV mod 5=${r}` };
    }

    // ====== å…«æˆ’åˆ«è·‘Â·ç»“æ„åŒ¹é…ä½ï¼ˆæœ€ç»ˆç‰ˆï¼‰=====
    // æ˜ å°„ï¼š23456 -> BCDEA
    // ç™½åå•ï¼š
    // 2(B): {2,4,8}
    // 3(C): {2,7,8}
    // 4(D): {2,4,8}
    // 5(E): {3,9}   ï¼ˆå·²è¸¢æ‰E=1ï¼‰
    // 6(A): {3,5,6}
    // åˆ†æµï¼šè‹¥ A<=Eï¼Œåˆ™åªå…è®¸ 2å·ä½ï¼ˆä¸”ä»éœ€Bç™½åå•ï¼‰ï¼›å¦åˆ™æŒ‰å‘½ä¸­ç™½åå•æ¨è
    // æ’åºï¼ˆç¡®ä¿ä¸å¯¹è¯ä¸€è‡´ï¼‰ï¼šè‹¥ 2&4 åŒæ—¶å‘½ä¸­ï¼šB=8 -> 4ä¼˜å…ˆï¼Œå¦åˆ™ 2ä¼˜å…ˆï¼›å…¶ä½™é¡ºåºï¼š4,2,5,3,6
    function model_bjb_struct(room5){
      const {A,B,C,D,E} = parseABCDE(room5);

      const WL = {
        2: new Set([2,4,8]),    // B
        3: new Set([2,7,8]),    // C
        4: new Set([2,4,8]),    // D
        5: new Set([3,9]),      // E
        6: new Set([3,5,6])     // A
      };

      const hits = [];
      const reasons = [];

      const aLeE = (A <= E);

      if(aLeE){
        // åˆ†æµï¼šåªå…è®¸2å·ä½
        if(WL[2].has(B)){
          hits.push(2);
          reasons.push(`åˆ†æµ(Aâ‰¤E)ï¼šåªæ‰“2å·ï½œB=${B}âœ…`);
        }else{
          return {
            action: "skip",
            recs: [],
            no1: null,
            no2: null,
            extra: `A=${A} B=${B} C=${C} D=${D} E=${E}ï½œåˆ†æµ(Aâ‰¤E)åªå…è®¸2å·ï¼Œä½†B=${B}ä¸åœ¨{2,4,8}`,
            tags: [{t:"è·³ï¼ˆåˆ†æµä¸æ»¡è¶³ï¼‰", cls:"red"}]
          };
        }
      }else{
        // å¸¸è§„ï¼šå‘½ä¸­ç™½åå•çš„ä½å­éƒ½å¯æ¨è
        if(WL[2].has(B)) { hits.push(2); }
        if(WL[3].has(C)) { hits.push(3); }
        if(WL[4].has(D)) { hits.push(4); }
        if(WL[5].has(E)) { hits.push(5); }
        if(WL[6].has(A)) { hits.push(6); }

        if(hits.length === 0){
          return {
            action: "skip",
            recs: [],
            no1: null,
            no2: null,
            extra: `A=${A} B=${B} C=${C} D=${D} E=${E}ï½œæ— ä½å­å‘½ä¸­ç™½åå•`,
            tags: [{t:"è·³ï¼ˆæ— å‘½ä¸­ï¼‰", cls:"red"}]
          };
        }
      }

      // æ’åºï¼šåŸºç¡€é¡ºåº 4,2,5,3,6
      const baseOrder = [4,2,5,3,6];

      // ç‰¹æ®Šï¼š2&4åŒä¸­æ—¶ï¼ŒB=8 -> 4ä¼˜å…ˆï¼Œå¦åˆ™2ä¼˜å…ˆ
      let ordered = hits.slice();

      const has2 = ordered.includes(2);
      const has4 = ordered.includes(4);

      // å…ˆæŒ‰baseOrderæ’åº
      ordered.sort((x,y)=> baseOrder.indexOf(x) - baseOrder.indexOf(y));

      // å†å¤„ç†2&4å†²çª
      if(has2 && has4){
        if(B === 8){
          // 4 åœ¨å‰
          ordered = ordered.filter(x=>x!==2 && x!==4);
          ordered.unshift(2);
          ordered.unshift(4);
        }else{
          // 2 åœ¨å‰
          ordered = ordered.filter(x=>x!==2 && x!==4);
          ordered.unshift(4);
          ordered.unshift(2);
        }
      }

      const recs = ordered.slice(0,2);
      const no1 = recs[0] ?? null;
      const no2 = recs[1] ?? null;

      const recText =
        (no1 && no2) ? `æ¨èNo1:${no1}å·ï½œæ¨èNo2:${no2}å·` :
        (no1) ? `æ¨èNo1:${no1}å·` :
        `è·³`;

      const seatBig =
        (no1 && no2) ? `No1 ${no1}ï½œNo2 ${no2}` :
        (no1) ? `${no1}å·` :
        `è·³`;

      const hitText = `å‘½ä¸­ä½=[${hits.join(",")}]`;
      const flowText = aLeE ? "åˆ†æµ(Aâ‰¤E)å¯ç”¨" : "å¸¸è§„(ä¸åˆ†æµ)";
      const extra = `A=${A} B=${B} C=${C} D=${D} E=${E}ï½œ${flowText}ï½œ${hitText}ï½œ${recText}`;

      const tags = [];
      tags.push({t: flowText, cls:"amber"});
      tags.push({t: (no1 ? "âœ…å¯æ‰“" : "âŒè·³"), cls: (no1 ? "green" : "red")});

      return {
        action: no1 ? "play" : "skip",
        recs,
        no1,
        no2,
        seatText: recText,
        seatBig,
        extra,
        tags
      };
    }

    // ====== UI æ¸²æŸ“ ======
    const roomEl = document.getElementById("room");
    const goEl = document.getElementById("go");
    const copyLastEl = document.getElementById("copyLast");
    const msgEl = document.getElementById("msg");
    const gridEl = document.getElementById("grid");
    const histBodyEl = document.getElementById("histBody");

    const copyAllEl = document.getElementById("copyAll");
    const exportCsvEl = document.getElementById("exportCsv");
    const clearAllEl = document.getElementById("clearAll");

    const LS_KEY = "nb_model_history_v2"; // â† å‡çº§ç‰ˆæœ¬ï¼Œé¿å…æ—§è¡¨ç»“æ„å†²çª
    const MAX_KEEP = 200; // æœ€å¤šä¿ç•™ 200 æ¡

    let lastTextToCopy = "";

    function cardHTML({name, seatText, extra, tags=[]}){
      const tagHTML = tags.map(x => `<span class="tag ${x.cls||""}">${escapeHtml(x.t)}</span>`).join("");
      return `
        <div class="card">
          <div class="cardHead">
            <div class="name"><span class="dot"></span>${escapeHtml(name)}</div>
            <div class="seatBig">${escapeHtml(seatText)}</div>
          </div>
          <div class="meta">
            <span class="tag">${escapeHtml(extra)}</span>
            ${tagHTML}
          </div>
        </div>
      `;
    }

    function computeAll(room5){
      const xj = model_xj(room5);
      const mj = model_mj(room5);
      const hA = model_hhh_A(room5);
      const hB = model_hhh_B(room5);
      const bj = model_bj(room5);
      const py = model_py(room5);
      const bjs = model_bjb_struct(room5);
      return {xj, mj, hA, hB, bj, py, bjs};
    }

    function renderCards(room5, out){
      const hTagsA = [
        {t:"æ¨¡å‹Aï¼š2/3ä¸»åŠ›å‚è€ƒ", cls:"amber"},
        ((out.hA.seat===2||out.hA.seat===3) ? {t:"âœ…è½åœ¨2/3", cls:"green"} : {t:"é2/3ï¼ˆä»è¾“å‡ºï¼‰", cls:""} )
      ];
      const hTagsB = [{t:"æ¨¡å‹Bï¼šåªå‡º4/5å¯¹å†²", cls:"amber"}];
      const bjTags = [ out.bj.strong ? {t:"ğŸ”¥ å¼ºä¿¡å·ï¼ˆå¯åŠ ä»“ï¼‰", cls:"green"} : {t:"æ™®é€šä¿¡å·ï¼ˆæ­£å¸¸ä»“ï¼‰", cls:""} ];

      const bjsTags = out.bjs.tags || [];

      gridEl.innerHTML = [
        cardHTML({name:"èœ¡ç¬”å°æ–°", seatText: `${out.xj.seat}å·`, extra: out.xj.extra}),
        cardHTML({name:"æ¢¦è§", seatText: `${out.mj.seat}å·`, extra: out.mj.extra}),
        cardHTML({name:"å‘µå‘µå‘µï¼ˆæ¨¡å‹Aï¼‰", seatText: `${out.hA.seat}å·`, extra: out.hA.extra, tags: hTagsA}),
        cardHTML({name:"å‘µå‘µå‘µï¼ˆæ¨¡å‹Bï¼‰", seatText: `${out.hB.seat}å·`, extra: out.hB.extra, tags: hTagsB}),
        cardHTML({name:"å…«æˆ’ï¼ˆFï¼‰", seatText: `${out.bj.seat}å·`, extra: out.bj.extra, tags: bjTags}),
        cardHTML({name:"åçˆ±", seatText: `${out.py.seat}å·`, extra: out.py.extra}),
        cardHTML({name:"å…«æˆ’åˆ«è·‘Â·ç»“æ„åŒ¹é…ä½", seatText: out.bjs.seatBig || "è·³", extra: out.bjs.extra, tags: bjsTags})
      ].join("");
      gridEl.style.display = "grid";
    }

    // ====== å†å²è®°å½•å­˜å– ======
    function loadHistory(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function addHistory(item){
      const arr = loadHistory();
      arr.unshift(item);
      if(arr.length > MAX_KEEP) arr.length = MAX_KEEP;
      saveHistory(arr);
      renderHistory();
    }

    function deleteHistory(id){
      const arr = loadHistory().filter(x => x.id !== id);
      saveHistory(arr);
      renderHistory();
    }

    function clearHistory(){
      saveHistory([]);
      renderHistory();
    }

    function renderHistory(){
      const arr = loadHistory();
      if(arr.length === 0){
        histBodyEl.innerHTML = `<tr><td colspan="10" style="color:rgba(255,255,255,.55);">æš‚æ— è®°å½•</td></tr>`;
        return;
      }

      histBodyEl.innerHTML = arr.map(row => `
        <tr>
          <td class="mono">${escapeHtml(fmtTime(row.ts))}</td>
          <td class="mono">${escapeHtml(row.room)}</td>
          <td class="mono">${escapeHtml(row.xj)}</td>
          <td class="mono">${escapeHtml(row.mj)}</td>
          <td class="mono">${escapeHtml(row.hA)}</td>
          <td class="mono">${escapeHtml(row.hB)}</td>
          <td class="mono">${escapeHtml(row.bj)}</td>
          <td class="mono">${escapeHtml(row.py)}</td>
          <td class="mono">${escapeHtml(row.bjs)}</td>
          <td><span class="del" data-del="${escapeHtml(row.id)}">åˆ </span></td>
        </tr>
      `).join("");

      // ç»‘å®šåˆ é™¤
      histBodyEl.querySelectorAll("[data-del]").forEach(el=>{
        el.addEventListener("click", ()=>deleteHistory(el.getAttribute("data-del")));
      });
    }

    // ====== å¤åˆ¶/å¯¼å‡º ======
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        msgEl.textContent = "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        msgEl.textContent = "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
      }
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    function buildCopyLine(room5, out){
      const t = fmtTime(Date.now());
      const strong = out.bj.strong ? "å¼º" : "æ™®";
      const bjs = out.bjs.action === "play"
        ? (out.bjs.no2 ? `No1:${out.bjs.no1} No2:${out.bjs.no2}` : `No1:${out.bjs.no1}`)
        : "è·³";
      return `${t} ${room5} ï½œ å°æ–°${out.xj.seat} æ¢¦è§${out.mj.seat} å‘µA${out.hA.seat} å‘µB${out.hB.seat} å…«æˆ’${out.bj.seat}(${strong}) åçˆ±${out.py.seat} ç»“æ„(${bjs})`;
    }

    function exportCSV(){
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "æš‚æ— è®°å½•å¯å¯¼å‡º";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      const header = ["time","room","xj","mj","hhhA","hhhB","bajieF","pianai","bajieStruct"];
      const rows = arr.map(r => [
        new Date(r.ts).toISOString(),
        r.room, r.xj, r.mj, r.hA, r.hB, r.bj, r.py, r.bjs
      ]);
      const csv = [header, ...rows]
        .map(line => line.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nb_model_history.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      msgEl.textContent = "âœ… CSV å·²å¯¼å‡º";
      setTimeout(()=>{ msgEl.textContent=""; }, 900);
    }

    // ====== ä¸»æµç¨‹ ======
    function run(){
      const s = roomEl.value.trim().replace(/\s+/g,"");
      if(!/^\d{5}$/.test(s)){
        msgEl.textContent = "è¯·è¾“å…¥æ­£ç¡®çš„5ä½æ•°å­—ï¼ˆä¾‹å¦‚ï¼š51330ï¼‰";
        gridEl.style.display = "none";
        gridEl.innerHTML = "";
        return;
      }

      const out = computeAll(s);
      renderCards(s, out);

      lastTextToCopy = buildCopyLine(s, out);

      // å†™å…¥å†å²ï¼ˆç”¨å±•ç¤ºå€¼ï¼Œä¾¿äºé˜…è¯»ï¼‰
      const bjsShort = (out.bjs.action === "play")
        ? (out.bjs.no2 ? `æ¨èNo1:${out.bjs.no1}å·ï½œæ¨èNo2:${out.bjs.no2}å·` : `æ¨èNo1:${out.bjs.no1}å·`)
        : `è·³ï½œ${out.bjs.extra}`;

      addHistory({
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        ts: Date.now(),
        room: s,
        xj: `${out.xj.seat}ï½œ${out.xj.extra}`,
        mj: `${out.mj.seat}ï½œ${out.mj.extra}`,
        hA: `${out.hA.seat}ï½œ${out.hA.extra}`,
        hB: `${out.hB.seat}ï½œ${out.hB.extra}`,
        bj: `${out.bj.seat}ï½œ${out.bj.extra}ï½œ${out.bj.strong ? "å¼º" : "æ™®"}`,
        py: `${out.py.seat}ï½œ${out.py.extra}`,
        bjs: bjsShort
      });

      msgEl.textContent = "";
      setTimeout(()=>{ roomEl.value=""; roomEl.focus(); }, 250);
    }

    goEl.addEventListener("click", run);
    roomEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });

    copyLastEl.addEventListener("click", ()=>{
      if(!lastTextToCopy){
        msgEl.textContent = "è¿˜æ²¡æœ‰æœ¬æ¬¡ç»“æœå¯å¤åˆ¶";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      copyText(lastTextToCopy);
    });

    copyAllEl.addEventListener("click", ()=>{
      const arr = loadHistory();
      if(arr.length===0){
        msgEl.textContent = "æš‚æ— è®°å½•å¯å¤åˆ¶";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
        return;
      }
      const lines = arr
        .slice()
        .reverse()
        .map(r => {
          const t = fmtTime(r.ts);
          const strong = (r.bj.includes("ï½œå¼º") ? "å¼º" : "æ™®");
          const seatOnly = (s)=>String(s).split("ï½œ")[0];
          return `${t} ${r.room} ï½œ å°æ–°${seatOnly(r.xj)} æ¢¦è§${seatOnly(r.mj)} å‘µA${seatOnly(r.hA)} å‘µB${seatOnly(r.hB)} å…«æˆ’${seatOnly(r.bj)}(${strong}) åçˆ±${seatOnly(r.py)} ç»“æ„(${r.bjs.split("ï½œ")[0]})`;
        });
      copyText(lines.join("\n"));
    });

    exportCsvEl.addEventListener("click", exportCSV);

    clearAllEl.addEventListener("click", ()=>{
      if(confirm("ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æˆ˜ç»©è®°å½•ï¼Ÿï¼ˆæœ¬æœºä¿å­˜ä¼šè¢«åˆ é™¤ï¼‰")){
        clearHistory();
        msgEl.textContent = "âœ… å·²æ¸…ç©º";
        setTimeout(()=>{ msgEl.textContent=""; }, 900);
      }
    });

    // åˆå§‹åŒ–
    renderHistory();
    roomEl.focus();

    // æ³¨å†Œç¦»çº¿
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js"));
    }
  </script>
</body>
</html>
